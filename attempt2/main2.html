<!DOCTYPE html>
<html>
<head>
	<script src="js/jquery-2.1.0.min.js" type="text/javascript"></script>
	<script src="js/jquery-ui-1.10.4.custom.min.js"></script>
	<!-- jquery smoothness theme -->
	<link rel="stylesheet" href="css/jquery-ui-1.10.4.custom.min.css">

	<style type="text/css">
		#canvas { margin-top:2px }
		.menuSection { width:400px; height:800px }
		section { float:left; padding:0 10px }
	</style>

	<!-- use http://s-yadav.github.io/contextMenu.html for the context menu? -->
	<script type="text/javascript">
		var hexScale = 16;
		var tileScale = hexScale * 7;
		var hexGrid = null;
		var tileGrid = null;
		var canvasElement = null;
		var menuItems = {};

		function newGridIndex(x, y) {
			return { gx: x, gy: y };
		};

		function drawCanvas() {
			var context = canvasElement[0].getContext("2d");

			tileGrid.draw(context);
			hexGrid.draw(context);

			/* TODO: draw grid overlay */
		};

		function addTileToMenu(id, drawFunction) {
			id = "menuTile_" + id;
			var tileMenuItem = window.newGrid(tileScale / 2, { sx: 1, sy: 1 });
			var drawableItem = window.drawableFactory.newDrawableSingle(id, drawFunction);
			menuItems[id] = drawableItem;

			tileMenuItem.addItem(
				window.newGridIndex(0, 0),
				"n",
				drawableItem,
				{ id: id }
			);

			$("<canvas id=\"" + id + "\"/>")
				.attr("class", "draggable")
				.attr("draggable", "true")
				.attr("ondragstart", "drag(event)")
				.attr("width", "120")
				.attr("height", "120")
				.data("drag-data", JSON.stringify({ id: id, type: "tile" }))
			.appendTo("<li/>")
			.appendTo($("#tiles"));

			var tileMenuItemContext = $("#" + id)[0].getContext("2d");
			tileMenuItem.draw(tileMenuItemContext);
		};

		//function addFeatureToMenu(id) {
		//
		//}

		function allowDrop(ev) {
			ev.preventDefault();
		}

		function drag(ev) {
			var data = $(ev.currentTarget).data("drag-data");
			ev.dataTransfer.setData("Text", data);
		}

		function drop(ev) {
			ev.preventDefault();

			var clickX = ev.pageX - canvasElement.offset().left;
			var clickY = ev.pageY - canvasElement.offset().top;
			var data = JSON.parse(ev.dataTransfer.getData("Text"));

			console.log("drop-at:[" + clickX + "," + clickY + "] data:" + data.id);

			if (data === undefined || data.type === undefined) {
				return;
			}

			switch (data.type) {
				case "tile": {
					var coordinates = tileGrid.getGridIndexFormPixelLocation({ px: clickX, py: clickY });
					tileGrid.addItem(coordinates, "n", menuItems[data.id], { id: data.id });
					break;
				}
				case "hex": {
					console.log("hex");
					break;
				}
				default: {
					console.log("undefined type dropped on canvas: " + data.type);
					return;
				}
			}

			drawCanvas();
		}

		$(function () {
			$("#menu").accordion({ heightStyle: "fill", collapsible: true, icons: false });

			tileGrid = window.newGrid(tileScale, { sx: 4, sy: 4 });
			hexGrid = window.newGrid(hexScale, { sx: 10, sy: 10 });

			/*hexGrid.addItem(window.newGridIndex(0, 0), "n", window.drawableFactory.newDrawableSingle("dummy", window.drawFuncs.dummyDraw));
			// turn this off while playing with inner grids on tiles
			hexGrid.addItem(window.newGridIndex(3, 3), "ne", window.drawableFactory.newDrawableMultiple(
				"dummyTwo",
				[
					{ draw: window.drawFuncs.dummyDraw },
					{ move: "s", draw: window.drawFuncs.dummyDraw },
					{ move: "s" },
					{ move: "s", draw: window.drawFuncs.dummyDraw },
				])
			);

			tileGrid.addItem(
				window.newGridIndex(1, 0),
				"ne",
				window.drawableFactory.newDrawableSingle("dummyTile", window.drawFuncs.dummyDrawTile),
				{ someData: "rabbit", otherData: "Maybe the tile movements would be good in here for drawing purpose so the tiles can be generated progamatically :O " }
			);*/

			addTileToMenu("one", window.drawFuncs.dummyDrawTile);

			canvasElement = $("#canvas");
			drawCanvas();

			canvasElement.click(function (e) {
				var pos = { px: e.pageX - canvasElement.offset().left, py: e.pageY - canvasElement.offset().top };
				var clickedIndex = hexGrid.getGridIndexFormPixelLocation(pos);
				// TODO: hilight item at position on hex grid or fall back and hilight hex
				console.log("clicked index " + JSON.stringify(clickedIndex));
			});
		});
	</script>
</head>
<body>
	<section class="menuSection">
		<div id="menu">
			<h3>Board tiles</h3>
			<div>
				<ul id="tiles"></ul>
			</div>
			<h3>Natrual and man-made features</h3>
			<div>
				<ul id="features">
					<li>Hill one</li>
					<li>Building one</li>
				</ul>
			</div>
			<h3>Objectives and  markers</h3>
			<div>
				<ul id="objectives">
					<li>Team A</li>
					<li>Team B</li>
					<li>Target</li>
				</ul>
			</div>
		</div>
	</section>
	<section>
		<canvas id="canvas" width="944" height="800" class="ui-widget-content ui-corner-all" ondrop="drop(event)" ondragover="allowDrop(event)"></canvas>
	</section>
	<script type="text/javascript" src="hexMaths.js"></script>
	<script type="text/javascript" src="gridCompas.js"></script>
	<script type="text/javascript" src="drawableFactory.js"></script>
	<script type="text/javascript" src="newGrid.js"></script>
	<script type="text/javascript" src="drawFuncs.js"></script>
</body>
</html>