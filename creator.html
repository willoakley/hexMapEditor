<!DOCTYPE html>
<html>
<head>
	<script src="js/jquery-2.1.0.min.js" type="text/javascript"></script>
	<script src="js/jquery-ui-1.10.4.custom.min.js"></script>
	<!-- jquery smoothness theme -->
	<link rel="stylesheet" href="css/jquery-ui-1.10.4.custom.min.css">
	<link rel="stylesheet" href="css/font-awesome.min.css">
	<style type="text/css">
		#canvas { margin-top:2px }
		.menuSection { width:400px; height:800px }
		section { float:left; padding:0 10px }
		.fake-link { text-decoration:underline; color:blue; cursor:pointer; }
	</style>

	<!-- use http://s-yadav.github.io/contextMenu.html for the context menu? -->
	<script type="text/javascript">
		var hexGrid = null;
		var tileGrid = null;
		var canvasElement = null;
		var menuItems = {};
		var selectedItem = null;

		function drawCanvas() {
			var context = getContextFromJquery(canvasElement);

			context.clearRect(0, 0, canvasElement.width(), canvasElement.height());
			tileGrid.draw(context);
			hexGrid.draw(context);
		};

		function addMenuItem(drawableItem, menuType) {
			var id = "menu" + menuType + "_" + drawableItem.id;
			var menuElementId = "#" + menuType + "Menu";
			var itemGrid = null;

			menuItems[id] = drawableItem;

			if (menuType == "tile") {
				itemGrid = window.newGrid(tileGrid.getScale() / 2, { sx: 1, sy: 1 });
			}
			else {
				itemGrid = window.newGrid(hexGrid.getScale() / 2, { sx: 9, sy: 7 });
			}

			itemGrid.addItem(window.newGridIndex(0, 0), "n", drawableItem, { id: id });

			$("<canvas id=\"" + id + "\"/>")
				.attr("class", "draggable")
				.attr("draggable", "true")
				.attr("ondragstart", "menuItemBeginDrag(event)")
				.attr("ondragend", "menuItemEndDrag(event)")
				.attr("width", "120")
				.attr("height", "120")
				.data("drag-data", JSON.stringify({ menuId: id, type: menuType }))
			.appendTo("<li/>")
			.appendTo($(menuElementId));

			var menuItemContext = getContextFromJquery($("#" + id));
			itemGrid.draw(menuItemContext);
		}

		function hilightSelectedGridPosition(position) {		
			var coordinates = trackingData.grid.getGridIndexFormPixelLocation({ px: position.px, py: position.py });

			if (trackingData.hilightItem != null && gridEquals(trackingData.hilightItem.positioning.startIndex, coordinates)) {
				if (coordinates.gx > trackingData.grid.getSize().sx || coordinates.gx < 0 || coordinates.gy > trackingData.grid.getSize().sy || coordinates.gy < 0) {
					trackingData.grid.removeItem(trackingData.hilightItem);
					drawCanvas();
				}

				return;
			}

			trackingData.grid.removeItem(trackingData.hilightItem);
			trackingData.hilightItem = trackingData.grid.addItem(coordinates, "n", window.drawableFactory.newDrawableSingle("hilight", window.drawFuncs.hilightHex), { id: "hilight" });
			drawCanvas();
		}

		function canvasClick(e) {
			var pos = { px: e.pageX - canvasElement.offset().left, py: e.pageY - canvasElement.offset().top };

			var hex = hexGrid.getItemAt(hexGrid.getGridIndexFormPixelLocation(pos));
			var tile = tileGrid.getItemAt(tileGrid.getGridIndexFormPixelLocation(pos));

			var item = null;
			if (hex == null && tile == null && selectedItem != null) {
				selectedItem.state = window.gridItemState.normal;
				selectedItem = null;
				drawCanvas();
			} else if (hex != null) {
				item = hex;
			} else if (tile != null) {
				item = tile;
			}

			if (item != selectedItem && selectedItem != null) {
				selectedItem.state = window.gridItemState.normal;
			}

			if (item != null) {
				if (item.state == window.gridItemState.normal) {
					item.state = window.gridItemState.selected
				} else {
					item.state = window.gridItemState.normal;
				}
			}

			selectedItem = item;
			drawCanvas();
		}

		function downloadMapLinkClick(ev) {
			this.href = canvasElement[0].toDataURL('image/png');
		}

		function rotateItemLink(ev) {
		}

		function removeItemLink(ev) {
		}

		$(function () {
			hexGrid = window.newGrid(16, { sx: 38, sy: 27 });
			tileGrid = window.newGrid(hexGrid.getScale() * 7, { sx: 4, sy: 4 });

			$("#downloadMapLink").click(downloadMapLinkClick);
			$("#rotateItemLink").click(rotateItemLink);
			$("#removeItemLink").click(removeItemLink);

			// Menus:
			$("#menu").accordion({ heightStyle: "fill", collapsible: true, icons: false });
			addMenuItem(window.drawableFactory.newDrawableSingle("one", window.drawFuncs.dummyDrawTile), "tile");

			addMenuItem(window.drawableFactory.newDrawableMultiple("two", [
				{ draw: window.drawFuncs.dummyDraw },
				{ move: "s", draw: window.drawFuncs.dummyDraw },
				{ move: "s" },
				{ move: "s", draw: window.drawFuncs.dummyDraw },
			]),"hex");

			// Map:
			canvasElement = $("#canvas");
			canvasElement.click(canvasClick);

			drawCanvas();
		});
	</script>
</head>
<body>
	<section class="menuSection">
		<div id="menu">
			<h3>Board tiles</h3>
			<div>
				<ul id="tileMenu"></ul>
			</div>
			<h3>Natrual and man-made features</h3>
			<div>
				<ul id="hexMenu"></ul>
			</div>
			<h3>Objectives and  markers</h3>
			<div>
				<ul id="objectives"></ul>
			</div>
		</div>
	</section>
	<section>
		<canvas id="canvas" width="944" height="800" class="ui-widget-content ui-corner-all" ondrop="canvasDrop(event)" ondragover="permitDropping(event)"></canvas>
	</section>
	<aside>
		<h3>Other bits and bobs</h3>
		<ul>
			<li><a id="downloadMapLink"class="fake-link" target="_blank"><i class="fa fa-download"></i> Download map as an image</a></li>
			<li><a id="rotateItemLink"class="fake-link"><i class="fa fa-repeat"></i> Rotate selected</a></li>
			<li><a id="removeItemLink"class="fake-link"><i class="fa fa-times"></i> Remove selected</a></li>
		</ul>
	</aside>
	<script type="text/javascript" src="hexMaths.js"></script>
	<script type="text/javascript" src="gridCompas.js"></script>
	<script type="text/javascript" src="drawableFactory.js"></script>
	<script type="text/javascript" src="newGrid.js"></script>
	<script type="text/javascript" src="drawFuncs.js"></script>
	<script type="text/javascript" src="utility.js"></script>
	<script type="text/javascript" src="dragDrop.js"></script>
</body>
</html>